using Test
using OpenQuantumSystems
using Random, SparseArrays, LinearAlgebra

@testset "trace" begin

    Random.seed!(0)

    D(op1::Array, op2::Array) = abs(norm(op1 - op2))
    D(x1::StateVector, x2::StateVector) = norm(x2 - x1)
    D(op1::AbstractOperator, op2::AbstractOperator) =
        abs(tracedistance_nh(dense(op1), dense(op2)))
    D(op1::AbstractSuperOperator, op2::AbstractSuperOperator) =
        abs(tracedistance_nh(dense(op1), dense(op2)))

    mode1 = Mode(0.2, 1.0)
    Energy = [0.0, 200.0]
    mol1 = Molecule([mode1], 3, Energy)
    mol2 = Molecule([mode1], 3, Energy)
    agg = Aggregate([mol1, mol2])
    aggInds = getIndices(agg)
    vibindices = getVibIndices(agg, aggInds)
    aggIndsLen = length(aggInds)
    basis = GenericBasis([aggIndsLen])
    FCFact = getFranckCondonFactors(agg, aggInds)
    Ham = getAggHamiltonian(agg, aggInds, FCFact)
    Ham_S = getAggHamSysBath2(agg, aggInds)
    Ham_int = Ham - Ham_S

    # data = Matrix(Hermitian(rand(ComplexF64, aggIndsLen, aggIndsLen)))
    data = ComplexF64[0.03329072524528315 + 0.0im 0.03403492592358183 + 0.057650448059614876im 0.006801292448377475 + 0.0161485556574719im 0.016087726035165027 + 0.006896301622661102im 0.01967381776216048 + 0.022970406374320122im 0.03322567826428457 + 0.06523207211054538im 0.05150309767430253 + 0.054103850901295984im 0.012040351120791035 + 0.021985819009261245im 0.031169364060041765 + 0.07598710394621389im 0.061817766961446245 + 0.02111102816321191im 0.05341429832266364 + 0.03025197226597304im 0.052232491269034925 + 0.00408017161733149im 0.07796688733892569 + 0.06314068205410225im 0.010929101814628875 + 0.05964491502440754im 0.06782823209714425 + 0.05652004022659361im 0.037700618946850534 + 0.0762717981184711im 0.06031297616425889 + 0.03115125591505133im 0.08061868015481789 + 0.022559573677236367im 0.012681433481269277 + 0.017107980561367166im 0.016413387676185415 + 0.05270948258879196im 0.026318668799009497 + 0.0420326955061268im 0.078295470240846 + 0.04068405743073453im 0.03657859584080421 + 0.06786258133608129im 0.053406414058901217 + 0.03142333377226126im 0.03413665789036723 + 0.04877642184887834im 0.02762922233989694 + 0.0727875542352259im 0.053728377836510445 + 0.05998443334190158im; 0.03403492592358183 - 0.057650448059614876im 0.07146599428338281 + 0.0im 0.00547696316760186 + 0.013414232768338835im 0.006949407312159948 + 0.047266629106401566im 0.07941628130879161 + 0.0482755995260731im 0.05293303189139826 + 0.05775700170444461im 0.013143009687726746 + 0.04230415303635853im 0.07214479447448459 + 0.025840612971072537im 0.028532959017786706 + 0.036410220130741924im 0.06290183090179047 + 0.02702378710818034im 0.019707920730505268 + 0.059687062111132144im 0.0036361514662822227 + 0.006638889946175301im 0.05162310344356458 + 0.012821346718788963im 0.05232917086046213 + 0.04920534266748497im 0.06522902039738393 + 0.05490329079088857im 0.07871404468276037 + 0.0686236778722173im 0.018413340584660938 + 0.006270615354075892im 0.07015768387843752 + 0.06305599608812616im 0.025779979633240357 + 0.04620200130062497im 0.07746170649363726 + 0.0010718999076863454im 0.0586025603236789 + 0.01336904830672625im 0.0006529678305700595 + 0.0169831510578266im 0.034423555402007325 + 0.005749208124917782im 0.06714753682216926 + 0.024262791440728054im 0.03946967538223501 + 0.0049075705919802495im 0.0765118163306613 + 0.05733637764445809im 0.053178698496717414 + 0.04905967262987167im; 0.006801292448377475 - 0.0161485556574719im 0.00547696316760186 - 0.013414232768338835im 0.024899721527131793 + 0.0im 0.07231239449684704 + 0.029079329784564203im 0.06190659678220142 + 0.05827632388458782im 0.05515887052159656 + 0.004609457868249544im 0.03875774367749035 + 0.004340458143564401im 0.05032979849719569 + 0.059502291264250225im 0.029344086773273725 + 0.06635359835581495im 0.06039558289007886 + 0.013354096587367035im 0.0025318214311753585 + 0.037107080085111134im 0.0679376011265881 + 0.010253443623650675im 0.07983551714797234 + 0.009639994617699602im 0.0672449861186429 + 0.060855131515965256im 0.010872622494842148 + 0.0809833982825343im 0.04687356707497032 + 0.008053752150732035im 0.06576605370803416 + 0.05861250696964282im 0.009456050328635088 + 0.020419803399341165im 0.06817173123966912 + 0.057919497159886785im 0.047219332362198566 + 0.04065850598017147im 0.016146371033034554 + 0.011110189979773321im 0.03065098982797048 + 0.025562460469121785im 0.012068214236384609 + 0.0730961867803549im 0.011284583426539272 + 0.07650402544444193im 0.014974897690330186 + 0.06927295349181319im 0.03548206214779452 + 0.06901049298233178im 0.037238444639427236 + 0.07211139103472447im; 0.016087726035165027 - 0.006896301622661102im 0.006949407312159948 - 0.047266629106401566im 0.07231239449684704 - 0.029079329784564203im 0.057995696462451944 + 0.0im 0.076853739250145 + 0.006544538654629173im 0.055945018046001146 + 0.05236313798046897im 0.02885811427834878 + 0.030087131091705674im 0.026116538456000704 + 0.0042298533311842775im 0.0435122500392832 + 0.05908074990041645im 0.05368956179771409 + 0.036168397663005204im 0.07312085848139509 + 0.030215823689995123im 0.07079046288280305 + 0.04039801676655547im 0.058112877859825794 + 0.05317698853821336im 0.04012270278282426 + 0.07401825880209718im 0.03344448013457501 + 0.06607355258119575im 0.002713423791065497 + 0.0699486097599348im 0.06941322550688903 + 0.01019799141180446im 0.03820881294432081 + 0.06842890379019463im 0.007522204088595142 + 0.02633259425318279im 0.04826597305236907 + 0.042923348928339794im 0.05260667707908281 + 0.061013792500780546im 0.06770010356086582 + 0.03751210044426999im 0.05353226616197927 + 0.03811853872614361im 0.038061094802817705 + 0.020829972289781177im 0.019726473649307547 + 0.003698827421651943im 0.02465680816484242 + 0.0046196954613733155im 0.0012830016225305252 + 0.055643777031558844im; 0.01967381776216048 - 0.022970406374320122im 0.07941628130879161 - 0.0482755995260731im 0.06190659678220142 - 0.05827632388458782im 0.076853739250145 - 0.006544538654629173im 0.057191616403585124 + 0.0im 0.007427396378845537 + 0.06872129462218347im 0.05929835048189157 + 0.02064880595146119im 0.05997411368983845 + 0.0809942627311258im 0.0784998476268983 + 0.03912004745382088im 0.039518014565575306 + 0.025178846470718125im 0.0664682727969522 + 0.01189440501996019im 0.050876503428753106 + 0.06981827555243962im 0.07446828796193385 + 0.06728946832765066im 0.02297021456780504 + 0.02308533667797859im 0.0678425936777844 + 0.035266766700661666im 0.026241124899201454 + 0.04005181332149008im 0.04537498396022155 + 0.026104350992629224im 0.037392514513334446 + 0.07720513623717616im 0.01484053545657396 + 0.07255297495245576im 0.017520173800976438 + 0.028714258026791707im 0.05615135504203764 + 0.0806610435626761im 0.0567845647833559 + 0.05329962325128598im 0.0031130098683011067 + 0.03782931528806763im 0.03632330786698253 + 0.012061366329239763im 0.020178555012391866 + 0.055508680068036116im 0.04823834190613416 + 0.03789088770560994im 0.01874459792623401 + 0.07058752134716234im; 0.03322567826428457 - 0.06523207211054538im 0.05293303189139826 - 0.05775700170444461im 0.05515887052159656 - 0.004609457868249544im 0.055945018046001146 - 0.05236313798046897im 0.007427396378845537 - 0.06872129462218347im 0.06968948260810717 + 0.0im 0.0022852530110744284 + 0.05679817866371505im 0.0540946873795014 + 0.07347344949713501im 0.03858837305434281 + 0.03744914888467822im 0.04477987603972848 + 0.03166832493498367im 0.022750387489357617 + 0.0436728389080912im 0.01600266459712809 + 0.07496914266757428im 0.0461981169730793 + 0.03961925829171364im 0.05049987440602301 + 0.02391866718687649im 0.05269925095524639 + 0.07286787456512123im 0.043930767465878345 + 0.023051349503697492im 0.01512029571055644 + 0.05908083079973683im 0.0295485739052348 + 0.04262818455666208im 0.08172278629520974 + 0.007844618728430263im 0.0006399387618997548 + 0.01060101629058871im 0.039502804026135846 + 0.07891591254164751im 0.05729548976117858 + 0.04056263327338313im 0.002270976148049091 + 0.03597232639815925im 0.055404808484150976 + 0.05959787374164981im 0.07339281915903985 + 0.0016805428743425833im 0.036006645001992854 + 0.04919392459551294im 0.05589921877505466 + 0.061121898833084734im; 0.05150309767430253 - 0.054103850901295984im 0.013143009687726746 - 0.04230415303635853im 0.03875774367749035 - 0.004340458143564401im 0.02885811427834878 - 0.030087131091705674im 0.05929835048189157 - 0.02064880595146119im 0.0022852530110744284 - 0.05679817866371505im 0.014716069241796435 + 0.0im 0.05707323739905406 + 0.07693839772945103im 0.02004555133949687 + 0.026353500014633078im 0.03396240716219968 + 0.025845541158486036im 0.07396165962170406 + 0.06972321017502014im 0.0639986186480783 + 0.07577817232354069im 0.03646335916091763 + 0.02676618975233233im 0.07296961973272365 + 0.03509810221632865im 0.017746155515588464 + 0.07895206978136451im 0.0424716025698215 + 0.054322359299478276im 0.06932120612237762 + 0.03438953636347359im 0.07930758922396018 + 0.06603616252115063im 0.01722830828626173 + 0.010656645446164948im 0.01013543456400329 + 0.0009587490038912764im 0.06209589693005831 + 0.018238783525787453im 0.06793363141477228 + 0.03915256034054116im 0.06168625961217084 + 0.026244510973791785im 0.015693354142758548 + 0.07347920413551452im 0.00031609757288962137 + 0.01749834706819246im 0.019160231216004502 + 0.020792687407564653im 0.048653437820930366 + 0.03540477052063261im; 0.012040351120791035 - 0.021985819009261245im 0.07214479447448459 - 0.025840612971072537im 0.05032979849719569 - 0.059502291264250225im 0.026116538456000704 - 0.0042298533311842775im 0.05997411368983845 - 0.0809942627311258im 0.0540946873795014 - 0.07347344949713501im 0.05707323739905406 - 0.07693839772945103im 0.052065492572599265 + 0.0im 0.07704977459279545 + 0.008004243944889614im 0.0062280237525686325 + 0.00910357439666997im 0.005784908521596902 + 0.05968996728376474im 0.059251784829895446 + 0.025482422648802197im 0.06298096690328209 + 0.06272283677691713im 0.025592561798909348 + 0.03376912731048994im 0.05159691421052892 + 0.07436274604337084im 0.07729626721729306 + 0.037343332698431514im 0.04918092782896211 + 0.05687345604696786im 6.389507263432694e-5 + 0.013252219989606418im 0.056948976837120496 + 0.060961067045289793im 0.07470718028404953 + 0.07577620490068714im 0.07069895726488484 + 0.034940934839901586im 0.003673457970323598 + 0.05964342843403307im 0.009522407933494622 + 0.025415729602735575im 0.053643644913517134 + 0.04752539655134447im 0.035535344767883566 + 0.029758989092002138im 0.041770888621483974 + 0.07313968898560932im 0.06196684559770946 + 0.04949517260022105im; 0.031169364060041765 - 0.07598710394621389im 0.028532959017786706 - 0.036410220130741924im 0.029344086773273725 - 0.06635359835581495im 0.0435122500392832 - 0.05908074990041645im 0.0784998476268983 - 0.03912004745382088im 0.03858837305434281 - 0.03744914888467822im 0.02004555133949687 - 0.026353500014633078im 0.07704977459279545 - 0.008004243944889614im 0.017880803514627033 + 0.0im 0.024405473154101152 + 0.041232028820898804im 0.0789551156555331 + 0.048952458717661795im 0.019732335659807154 + 0.06084002307578201im 0.027806042860788575 + 0.005104421136864926im 0.030128016640776058 + 0.07422843142806101im 0.036095688604009614 + 0.045855952119427085im 0.027261585538955014 + 0.010705338936478388im 0.05376823226870516 + 0.013461127737450224im 0.0286369329761891 + 0.027602455496854035im 0.06992727799059399 + 0.04889209364725181im 0.00268114269706158 + 0.08166112746643259im 0.0425242912581785 + 0.07804312782959041im 0.044142215771648584 + 0.025496787464709122im 0.006410664298889032 + 0.03703169349121365im 0.07069447358460451 + 0.030049766487923915im 0.017528154009249917 + 0.03745620255975764im 0.018117514201955905 + 0.06724614730025638im 0.029837079807732644 + 0.0728593422378547im; 0.061817766961446245 - 0.02111102816321191im 0.06290183090179047 - 0.02702378710818034im 0.06039558289007886 - 0.013354096587367035im 0.05368956179771409 - 0.036168397663005204im 0.039518014565575306 - 0.025178846470718125im 0.04477987603972848 - 0.03166832493498367im 0.03396240716219968 - 0.025845541158486036im 0.0062280237525686325 - 0.00910357439666997im 0.024405473154101152 - 0.041232028820898804im 0.043812093782429104 + 0.0im 0.02972059765124313 + 0.07301369151226061im 0.02419438534960433 + 0.003072785815990953im 0.011857901953411767 + 0.05646288168893135im 0.023751937353600844 + 0.005212173783209035im 0.04671911711467291 + 0.04255020322208155im 0.049144081747893364 + 0.04226148633146618im 0.038529458367380184 + 0.03721856503453349im 0.0019972017653431553 + 0.06393525780887543im 0.02583879410129819 + 0.020426244453916866im 0.03454971655157826 + 0.017817924647487236im 0.008416205496298842 + 0.024208617284193754im 0.02577949530398093 + 0.06208108536481424im 0.054072740192919674 + 0.015622084941548979im 0.07904009172375513 + 0.0439443410326542im 0.009901051629930262 + 0.05913394052101224im 0.03231189893806298 + 0.07412996011383108im 0.07732101445588252 + 0.028477989016753594im; 0.05341429832266364 - 0.03025197226597304im 0.019707920730505268 - 0.059687062111132144im 0.0025318214311753585 - 0.037107080085111134im 0.07312085848139509 - 0.030215823689995123im 0.0664682727969522 - 0.01189440501996019im 0.022750387489357617 - 0.0436728389080912im 0.07396165962170406 - 0.06972321017502014im 0.005784908521596902 - 0.05968996728376474im 0.0789551156555331 - 0.048952458717661795im 0.02972059765124313 - 0.07301369151226061im 0.04959482177783313 + 0.0im 0.006992318864355267 + 0.06594378202734255im 0.08098163948864405 + 0.02039184411394822im 0.08040152506785776 + 0.022644959954856422im 0.020170800615887174 + 0.02540326283627464im 0.03935494924907584 + 0.02198975282366211im 0.04966579649146746 + 0.07009930997364133im 0.044992753733637 + 0.061223061862723194im 0.019845909405184377 + 0.08048747589343024im 0.053775868246288695 + 0.04348139108019725im 0.022495185574391056 + 0.05704915200799104im 0.00850032452528793 + 0.038672709184231366im 0.010430370915549126 + 0.05631749747003302im 0.021539798538965104 + 0.06660823404595435im 0.07446726772441097 + 0.004123256750639771im 0.005204851239673825 + 0.06915883817399106im 0.04541418596167242 + 0.07302334523371543im; 0.052232491269034925 - 0.00408017161733149im 0.0036361514662822227 - 0.006638889946175301im 0.0679376011265881 - 0.010253443623650675im 0.07079046288280305 - 0.04039801676655547im 0.050876503428753106 - 0.06981827555243962im 0.01600266459712809 - 0.07496914266757428im 0.0639986186480783 - 0.07577817232354069im 0.059251784829895446 - 0.025482422648802197im 0.019732335659807154 - 0.06084002307578201im 0.02419438534960433 - 0.003072785815990953im 0.006992318864355267 - 0.06594378202734255im 0.001791642074975939 + 0.0im 0.04653385628129449 + 0.00774696154818365im 0.005980862186252743 + 0.06150363813290991im 0.03938481407868253 + 0.01971849989475295im 0.04623043131938364 + 0.046970035652688716im 0.015760890685258676 + 0.026768073698224454im 0.05802796423293922 + 0.07088205750860715im 0.02234267316176281 + 0.07136808820015039im 0.0008686894151798487 + 0.0002799768328668275im 0.03842288338334435 + 0.049714786090470864im 0.006712413448165306 + 0.004011929179197467im 0.04559280713177523 + 0.039548402894507874im 0.0768953527693953 + 0.06397577339305044im 0.051167276410817066 + 0.04924004066707327im 0.06872856245245007 + 0.07547509451062533im 0.017319122093858542 + 0.07077125408151415im; 0.07796688733892569 - 0.06314068205410225im 0.05162310344356458 - 0.012821346718788963im 0.07983551714797234 - 0.009639994617699602im 0.058112877859825794 - 0.05317698853821336im 0.07446828796193385 - 0.06728946832765066im 0.0461981169730793 - 0.03961925829171364im 0.03646335916091763 - 0.02676618975233233im 0.06298096690328209 - 0.06272283677691713im 0.027806042860788575 - 0.005104421136864926im 0.011857901953411767 - 0.05646288168893135im 0.08098163948864405 - 0.02039184411394822im 0.04653385628129449 - 0.00774696154818365im 0.02987950671783604 + 0.0im 0.04963021046434227 + 0.014973176616671718im 0.07862066256216503 + 0.02779354106833267im 0.02215964324951796 + 0.06238060156879421im 0.027884214448456887 + 0.02816913569995384im 0.06173571378830742 + 0.023987660096979252im 0.023623002687617023 + 0.041376349492037834im 0.009425343362235886 + 0.01824238841272917im 0.0055665672068566955 + 0.051896804270931775im 0.0019830714809287125 + 0.016604973658202606im 0.004393085337812734 + 0.07052730908820623im 0.07566346158428158 + 0.06962113391472835im 0.05433561905716573 + 0.04746592010489047im 0.053627476800990385 + 0.05015362243113797im 0.0611062194608261 + 0.02510294007755934im; 0.010929101814628875 - 0.05964491502440754im 0.05232917086046213 - 0.04920534266748497im 0.0672449861186429 - 0.060855131515965256im 0.04012270278282426 - 0.07401825880209718im 0.02297021456780504 - 0.02308533667797859im 0.05049987440602301 - 0.02391866718687649im 0.07296961973272365 - 0.03509810221632865im 0.025592561798909348 - 0.03376912731048994im 0.030128016640776058 - 0.07422843142806101im 0.023751937353600844 - 0.005212173783209035im 0.08040152506785776 - 0.022644959954856422im 0.005980862186252743 - 0.06150363813290991im 0.04963021046434227 - 0.014973176616671718im 0.03464088000637096 + 0.0im 0.004425845971850412 + 0.027963211694951782im 0.02065205276173657 + 0.03705918128233154im 0.0741090611390331 + 0.0179118753041398im 0.07526140092562567 + 0.07144542385071381im 0.04665815114751655 + 0.07895495812033526im 0.018914874994396248 + 0.015187542483370002im 0.004997821093939942 + 0.0698170023656273im 0.022096099715058784 + 0.04972370863993607im 0.0313632647444139 + 0.07183291614587464im 0.008007569053011315 + 0.013673905245820472im 0.039319357508437985 + 0.06566913018336087im 0.0645532233221778 + 0.02481822329586301im 0.0720297824208744 + 0.0629619357756722im; 0.06782823209714425 - 0.05652004022659361im 0.06522902039738393 - 0.05490329079088857im 0.010872622494842148 - 0.0809833982825343im 0.03344448013457501 - 0.06607355258119575im 0.0678425936777844 - 0.035266766700661666im 0.05269925095524639 - 0.07286787456512123im 0.017746155515588464 - 0.07895206978136451im 0.05159691421052892 - 0.07436274604337084im 0.036095688604009614 - 0.045855952119427085im 0.04671911711467291 - 0.04255020322208155im 0.020170800615887174 - 0.02540326283627464im 0.03938481407868253 - 0.01971849989475295im 0.07862066256216503 - 0.02779354106833267im 0.004425845971850412 - 0.027963211694951782im 0.03677359197151137 + 0.0im 0.04531977313385281 + 0.04313032466519941im 0.055630809445645114 + 0.07531888225947912im 0.02715602243312948 + 0.02761196711332463im 0.040531973747841954 + 0.05871085752802161im 0.07138475252042423 + 0.010343232900346068im 0.046778799734925186 + 0.0051740235061913525im 0.0003773940367565649 + 0.015513431771594297im 0.062111317345851375 + 0.07735171827268478im 0.05135078527175955 + 0.03217953056473373im 0.051831416494202524 + 0.050482046292884865im 0.07501471078015214 + 0.0749627097641732im 0.05389177950685958 + 0.05600719540077414im; 0.037700618946850534 - 0.0762717981184711im 0.07871404468276037 - 0.0686236778722173im 0.04687356707497032 - 0.008053752150732035im 0.002713423791065497 - 0.0699486097599348im 0.026241124899201454 - 0.04005181332149008im 0.043930767465878345 - 0.023051349503697492im 0.0424716025698215 - 0.054322359299478276im 0.07729626721729306 - 0.037343332698431514im 0.027261585538955014 - 0.010705338936478388im 0.049144081747893364 - 0.04226148633146618im 0.03935494924907584 - 0.02198975282366211im 0.04623043131938364 - 0.046970035652688716im 0.02215964324951796 - 0.06238060156879421im 0.02065205276173657 -  0.03705918128233154im 0.04531977313385281 - 0.04313032466519941im 0.017751743400005862 + 0.0im 0.00574138010053761 + 0.05535993255657073im 0.008436843561101312 + 0.025445162826102312im 0.0698038614576272 + 0.06677308570412296im 0.05296227993075517 + 0.022317752675740005im 0.024338002328854524 + 0.006716070903730296im 0.04575541373319499 + 0.042961787547978594im 0.030200793552772397 + 0.015132944123472365im 0.07796263664951342 + 0.04961704233487216im 0.07592717336153416 + 0.0757917592249117im 0.03212067070448388 + 0.03027995633296361im 0.021136585724839164 + 0.020203778271818584im; 0.06031297616425889 - 0.03115125591505133im 0.018413340584660938 - 0.006270615354075892im 0.06576605370803416 - 0.05861250696964282im 0.06941322550688903 - 0.01019799141180446im 0.04537498396022155 - 0.026104350992629224im 0.01512029571055644 - 0.05908083079973683im 0.06932120612237762 - 0.03438953636347359im 0.04918092782896211 - 0.05687345604696786im 0.05376823226870516 - 0.013461127737450224im 0.038529458367380184 - 0.03721856503453349im 0.04966579649146746 - 0.07009930997364133im 0.015760890685258676 - 0.026768073698224454im 0.027884214448456887 - 0.02816913569995384im 0.0741090611390331 - 0.0179118753041398im 0.055630809445645114 - 0.07531888225947912im 0.00574138010053761 - 0.05535993255657073im 0.02999200477543371 + 0.0im 0.006211491568910921 + 0.01905174278473824im 0.03823144019623116 + 0.006576678427728856im 0.07910288725658186 + 0.014677550286055985im 0.0015928254808934591 + 0.00401180725100281im 0.014551824283472894 + 0.029222980086559037im 0.025918192669007134 + 0.07854394579874603im 0.07034641517951667 + 0.018600835695823374im 0.044096388547480526 + 0.04284229172356817im 0.07378424925436904 + 0.03271442360709947im 0.0780292010371292 + 0.07774006039883385im; 0.08061868015481789 - 0.022559573677236367im 0.07015768387843752 - 0.06305599608812616im 0.009456050328635088 - 0.020419803399341165im 0.03820881294432081 - 0.06842890379019463im 0.037392514513334446 - 0.07720513623717616im 0.0295485739052348 - 0.04262818455666208im 0.07930758922396018 - 0.06603616252115063im 6.389507263432694e-5 - 0.013252219989606418im 0.0286369329761891 - 0.027602455496854035im 0.0019972017653431553 - 0.06393525780887543im 0.044992753733637 - 0.061223061862723194im 0.05802796423293922 - 0.07088205750860715im 0.06173571378830742 - 0.023987660096979252im 0.07526140092562567 - 0.07144542385071381im 0.02715602243312948 - 0.02761196711332463im 0.008436843561101312 - 0.025445162826102312im 0.006211491568910921 - 0.01905174278473824im 0.008385200999122544 + 0.0im 0.036809539868516594 + 0.03422562170469592im 0.05854828456501621 + 0.018736331775666547im 0.014684289802901146 + 0.08049424050214651im 0.001742052239919672 + 0.0323378189225221im 0.07971260784398662 + 0.04524395116962639im 0.02352961213747994 + 0.054503049904338186im 0.05167698436674705 + 0.0410284173456858im 0.031023042803288478 + 0.0789651894993083im 0.050905534909680354 + 0.011588664472273226im; 0.012681433481269277 - 0.017107980561367166im 0.025779979633240357 - 0.04620200130062497im 0.06817173123966912 - 0.057919497159886785im 0.007522204088595142 - 0.02633259425318279im 0.01484053545657396 - 0.07255297495245576im 0.08172278629520974 - 0.007844618728430263im 0.01722830828626173 - 0.010656645446164948im 0.056948976837120496 - 0.060961067045289793im 0.06992727799059399 - 0.04889209364725181im 0.02583879410129819 - 0.020426244453916866im 0.019845909405184377 - 0.08048747589343024im 0.02234267316176281 - 0.07136808820015039im 0.023623002687617023 - 0.041376349492037834im 0.04665815114751655 - 0.07895495812033526im 0.040531973747841954 - 0.05871085752802161im 0.0698038614576272 - 0.06677308570412296im 0.03823144019623116 - 0.006576678427728856im 0.036809539868516594 - 0.03422562170469592im 0.07856003713667302 + 0.0im 0.011070563810029372 + 0.0031693587369791307im 0.0774264286984309 + 0.025884031737081814im 0.014541081754440003 + 0.0806135298337283im 0.0680897581185484 + 0.023680856760558977im 0.009037329451894373 + 0.08125881263550146im 0.08036738829048112 + 0.04379130759372152im 0.014317088408253166 + 0.05207194611572409im 0.04646015660009463 + 0.05596581552559807im; 0.016413387676185415 - 0.05270948258879196im 0.07746170649363726 - 0.0010718999076863454im 0.047219332362198566 - 0.04065850598017147im 0.04826597305236907 - 0.042923348928339794im 0.017520173800976438 - 0.028714258026791707im 0.0006399387618997548 - 0.01060101629058871im 0.01013543456400329 - 0.0009587490038912764im 0.07470718028404953 - 0.07577620490068714im 0.00268114269706158 - 0.08166112746643259im 0.03454971655157826 - 0.017817924647487236im 0.053775868246288695 - 0.04348139108019725im 0.0008686894151798487 - 0.0002799768328668275im 0.009425343362235886 - 0.01824238841272917im 0.018914874994396248 - 0.015187542483370002im 0.07138475252042423 - 0.010343232900346068im 0.05296227993075517 - 0.022317752675740005im 0.07910288725658186 - 0.014677550286055985im 0.05854828456501621 - 0.018736331775666547im 0.011070563810029372 - 0.0031693587369791307im 0.014032845585170737 + 0.0im 0.06201080542498772 + 0.036521128209878566im 0.03808086059577123 + 0.014740124147408534im 0.03502739110774345 + 0.016900469904146006im 0.07194001772030587 + 0.04201870980269924im 0.025646463397882627 + 0.00390408059445747im 0.0720960686574925 + 0.07097802258292797im 0.04742380575257632 + 0.012159924931924738im; 0.026318668799009497 - 0.0420326955061268im 0.0586025603236789 - 0.01336904830672625im 0.016146371033034554 - 0.011110189979773321im 0.05260667707908281 - 0.061013792500780546im 0.05615135504203764 - 0.0806610435626761im 0.039502804026135846 - 0.07891591254164751im 0.06209589693005831 - 0.018238783525787453im 0.07069895726488484 - 0.034940934839901586im 0.0425242912581785 - 0.07804312782959041im 0.008416205496298842 - 0.024208617284193754im 0.022495185574391056 - 0.05704915200799104im 0.03842288338334435 - 0.049714786090470864im 0.0055665672068566955 - 0.051896804270931775im 0.004997821093939942 - 0.0698170023656273im 0.046778799734925186 - 0.0051740235061913525im 0.024338002328854524 - 0.006716070903730296im 0.0015928254808934591 - 0.00401180725100281im 0.014684289802901146 - 0.08049424050214651im 0.0774264286984309 - 0.025884031737081814im 0.06201080542498772 - 0.036521128209878566im 0.0019559829914959108 + 0.0im 0.03306818412704267 + 0.02327268765705391im 0.04013318211627876 + 0.049443331814243964im 0.021850207068707002 + 0.05859722486537432im 0.07964756096655841 + 0.005534318513010751im 0.00568064348076665 + 0.05848548693341136im 0.07367937920969923 + 0.042132957183558445im; 0.078295470240846 - 0.04068405743073453im 0.0006529678305700595 - 0.0169831510578266im 0.03065098982797048 - 0.025562460469121785im 0.06770010356086582 - 0.03751210044426999im 0.0567845647833559 - 0.05329962325128598im 0.05729548976117858 - 0.04056263327338313im 0.06793363141477228 - 0.03915256034054116im 0.003673457970323598 - 0.05964342843403307im 0.044142215771648584 - 0.025496787464709122im 0.02577949530398093 - 0.06208108536481424im 0.00850032452528793 - 0.038672709184231366im 0.006712413448165306 - 0.004011929179197467im 0.0019830714809287125 - 0.016604973658202606im 0.022096099715058784 - 0.04972370863993607im 0.0003773940367565649 - 0.015513431771594297im 0.04575541373319499 - 0.042961787547978594im 0.014551824283472894 - 0.029222980086559037im 0.001742052239919672 - 0.0323378189225221im 0.014541081754440003 - 0.0806135298337283im 0.03808086059577123 - 0.014740124147408534im 0.03306818412704267 - 0.02327268765705391im 0.011526845336055185 + 0.0im 0.04729828064924493 + 0.0366051631243573im 0.016988890264997142 + 0.0012958665542645838im 0.0571777885248295 + 0.026077725844435132im 0.04743515937659382 + 0.06036873399550427im 0.000371108584578139 + 0.06177766187376315im; 0.03657859584080421 - 0.06786258133608129im 0.034423555402007325 - 0.005749208124917782im 0.012068214236384609 - 0.0730961867803549im 0.05353226616197927 - 0.03811853872614361im 0.0031130098683011067 - 0.03782931528806763im 0.002270976148049091 - 0.03597232639815925im 0.06168625961217084 - 0.026244510973791785im 0.009522407933494622 - 0.025415729602735575im 0.006410664298889032 - 0.03703169349121365im 0.054072740192919674 - 0.015622084941548979im 0.010430370915549126 - 0.05631749747003302im 0.04559280713177523 - 0.039548402894507874im 0.004393085337812734 - 0.07052730908820623im 0.0313632647444139 - 0.07183291614587464im 0.062111317345851375 - 0.07735171827268478im 0.030200793552772397 - 0.015132944123472365im 0.025918192669007134 - 0.07854394579874603im 0.07971260784398662 - 0.04524395116962639im 0.0680897581185484 - 0.023680856760558977im 0.03502739110774345 - 0.016900469904146006im 0.04013318211627876 - 0.049443331814243964im 0.04729828064924493 - 0.0366051631243573im 0.009848380109629058 + 0.0im 0.06103028910811902 + 0.06739332760913049im 0.08187311679486026 + 0.05225778487387483im 0.02272005060807749 + 0.02619121439462892im 0.04248671161698166 + 0.017380626958929984im; 0.053406414058901217 - 0.03142333377226126im 0.06714753682216926 - 0.024262791440728054im 0.011284583426539272 - 0.07650402544444193im 0.038061094802817705 - 0.020829972289781177im 0.03632330786698253 - 0.012061366329239763im 0.055404808484150976 - 0.05959787374164981im 0.015693354142758548 - 0.07347920413551452im 0.053643644913517134 - 0.04752539655134447im 0.07069447358460451 - 0.030049766487923915im 0.07904009172375513 - 0.0439443410326542im 0.021539798538965104 - 0.06660823404595435im 0.0768953527693953 - 0.06397577339305044im 0.07566346158428158 - 0.06962113391472835im 0.008007569053011315 - 0.013673905245820472im 0.05135078527175955 - 0.03217953056473373im 0.07796263664951342 - 0.04961704233487216im 0.07034641517951667 - 0.018600835695823374im 0.02352961213747994 - 0.054503049904338186im 0.009037329451894373 - 0.08125881263550146im 0.07194001772030587 - 0.04201870980269924im 0.021850207068707002 - 0.05859722486537432im 0.016988890264997142 - 0.0012958665542645838im 0.06103028910811902 - 0.06739332760913049im 0.019848418615813566 + 0.0im 0.035210662947159015 + 0.07283380918038664im 0.04915125162345565 + 0.03629506132706544im 0.010248019265687266 + 0.05097375783390434im; 0.03413665789036723 - 0.04877642184887834im 0.03946967538223501 - 0.0049075705919802495im 0.014974897690330186 - 0.06927295349181319im 0.019726473649307547 - 0.003698827421651943im 0.020178555012391866 - 0.055508680068036116im 0.07339281915903985 - 0.0016805428743425833im 0.00031609757288962137 - 0.01749834706819246im 0.035535344767883566 - 0.029758989092002138im 0.017528154009249917 - 0.03745620255975764im 0.009901051629930262 - 0.05913394052101224im 0.07446726772441097 - 0.004123256750639771im 0.051167276410817066 - 0.04924004066707327im 0.05433561905716573 - 0.04746592010489047im 0.039319357508437985 - 0.06566913018336087im 0.051831416494202524 - 0.050482046292884865im 0.07592717336153416 - 0.0757917592249117im 0.044096388547480526 - 0.04284229172356817im 0.05167698436674705 - 0.0410284173456858im 0.08036738829048112 - 0.04379130759372152im 0.025646463397882627 - 0.00390408059445747im 0.07964756096655841 - 0.005534318513010751im 0.0571777885248295 - 0.026077725844435132im 0.08187311679486026 - 0.05225778487387483im 0.035210662947159015 - 0.07283380918038664im 0.062017005045086684 + 0.0im 0.04523459640164877 + 0.008859869008123975im 0.0095081553917966 + 0.00310095848760127im; 0.02762922233989694 - 0.0727875542352259im 0.0765118163306613 - 0.05733637764445809im 0.03548206214779452 - 0.06901049298233178im 0.02465680816484242 - 0.0046196954613733155im 0.04823834190613416 - 0.03789088770560994im 0.036006645001992854 - 0.04919392459551294im 0.019160231216004502 - 0.020792687407564653im 0.041770888621483974 - 0.07313968898560932im 0.018117514201955905 - 0.06724614730025638im 0.03231189893806298 - 0.07412996011383108im 0.005204851239673825 - 0.06915883817399106im 0.06872856245245007 - 0.07547509451062533im 0.053627476800990385 - 0.05015362243113797im 0.0645532233221778 - 0.02481822329586301im 0.07501471078015214 - 0.0749627097641732im 0.03212067070448388 - 0.03027995633296361im 0.07378424925436904 - 0.03271442360709947im 0.031023042803288478 - 0.0789651894993083im 0.014317088408253166 - 0.05207194611572409im 0.0720960686574925 - 0.07097802258292797im 0.00568064348076665 - 0.05848548693341136im 0.04743515937659382 - 0.06036873399550427im 0.02272005060807749 - 0.02619121439462892im 0.04915125162345565 - 0.03629506132706544im 0.04523459640164877 - 0.008859869008123975im 0.07697600683517103 + 0.0im 0.0064542988395152835 + 0.03445036108905843im; 0.053728377836510445 - 0.05998443334190158im 0.053178698496717414 - 0.04905967262987167im 0.037238444639427236 - 0.07211139103472447im 0.0012830016225305252 - 0.055643777031558844im 0.01874459792623401 - 0.07058752134716234im 0.05589921877505466 - 0.061121898833084734im 0.048653437820930366 - 0.03540477052063261im 0.06196684559770946 - 0.04949517260022105im 0.029837079807732644 - 0.0728593422378547im 0.07732101445588252 - 0.028477989016753594im 0.04541418596167242 - 0.07302334523371543im 0.017319122093858542 - 0.07077125408151415im 0.0611062194608261 - 0.02510294007755934im 0.0720297824208744 - 0.0629619357756722im 0.05389177950685958 - 0.05600719540077414im 0.021136585724839164 - 0.020203778271818584im 0.0780292010371292 - 0.07774006039883385im 0.050905534909680354 - 0.011588664472273226im 0.04646015660009463 - 0.05596581552559807im 0.04742380575257632 - 0.012159924931924738im 0.07367937920969923 - 0.042132957183558445im 0.000371108584578139 - 0.06177766187376315im 0.04248671161698166 - 0.017380626958929984im 0.010248019265687266 - 0.05097375783390434im 0.0095081553917966 - 0.00310095848760127im 0.0064542988395152835 - 0.03445036108905843im 0.07341739098042155 + 0.0im]
    rho0 = DenseOperator(basis, basis, data)
    normalize!(rho0)
    # println(rho0.data)

    t = 0.0
    U_op = evolutionOperator(Ham, t)
    rho = U_op * rho0 * U_op'
    rho_traced_ref = ComplexF64[0.3991955704987049 + 0.0im 0.20541470913545595 + 0.2687219610896837im 0.22704031650453424 + 0.12827020594524244im; 0.20541470913545587 - 0.26872196108968366im 0.26683353171581814 + 3.469446951953614e-18im 0.02733560904197175 + 0.1265393998931935im; 0.22704031650453424 - 0.12827020594524247im 0.0273356090419717 - 0.12653939989319346im 0.3486601335314465 - 3.0357660829594124e-18im]
    rho_traced = trace_bath_slow(rho, agg, FCFact, aggInds, vibindices)
    # println(rho_traced.data)
    @test 1e-7 > D(rho_traced.data, rho_traced_ref)
    rho_traced =
        trace_bath_slow(rho.data, agg, FCFact, aggInds, vibindices)
    @test 1e-7 > D(rho_traced, rho_traced_ref)

    FCProd = getFCProd(agg, FCFact, aggInds, vibindices)
    rho_traced = trace_bath(rho, agg, FCProd, aggInds, vibindices)
    @test 1e-7 > D(rho_traced.data, rho_traced_ref)
    rho_traced = trace_bath(rho.data, agg, FCProd, aggInds, vibindices)
    @test 1e-7 > D(rho_traced, rho_traced_ref)

    for a = 1:3, b = 1:3
        rho_traced_ab = trace_bath(rho, a, b, agg, FCProd, aggInds, vibindices)
        @test 1e-7 > abs(rho_traced_ref[a, b] - rho_traced_ab)
    end

    rho_bath = get_rho_bath(rho0, agg, FCProd, aggInds, vibindices)
    rho_traced = trace_bath(rho_bath, agg, FCProd, aggInds, vibindices)
    rho_traced_ref = [1.0 1.0 1.0; 1.0 1.0 1.0; 1.0 1.0 1.0]
    @test 1e-10 > D(rho_traced_ref, rho_traced.data)

    rho_traced = trace_bath(rho0, agg, FCProd, aggInds, vibindices)
    rho0_ad = ad(rho_traced, rho_bath, agg, FCProd, aggInds, vibindices)
    @test 1e-7 > D(rho0, rho0_ad)

    t = 1.0
    U_op = evolutionOperator(Ham, t)
    rho = U_op * rho0 * U_op'
    rho_traced_ref = ComplexF64[0.3991955704987056 + 1.5143833912028213e-18im 0.34421216548155814 + 0.026578788900858664im 0.23249244241092146 - 0.06845493380812484im; 0.3442121654815582 - 0.026578788900858668im 0.26251426646466225 + 7.766321541503774e-18im 0.03930563826397039 + 0.11275805402252118im; 0.23249244241092146 + 0.06845493380812483im 0.0393056382639704 - 0.11275805402252127im 0.33124026048752686 - 1.734723475976807e-18im]

    rho_traced = trace_bath_slow(rho, agg, FCFact, aggInds, vibindices)
    # println(rho_traced.data)
    @test 1e-7 > D(rho_traced.data, rho_traced_ref)
    rho_traced =
        trace_bath_slow(rho.data, agg, FCFact, aggInds, vibindices)
    @test 1e-7 > D(rho_traced, rho_traced_ref)

    FCProd = getFCProd(agg, FCFact, aggInds, vibindices)
    rho_traced = trace_bath(rho, agg, FCProd, aggInds, vibindices)
    @test 1e-7 > D(rho_traced.data, rho_traced_ref)
    rho_traced = trace_bath(rho.data, agg, FCProd, aggInds, vibindices)
    @test 1e-7 > D(rho_traced, rho_traced_ref)

    for a = 1:3, b = 1:3
        rho_traced_ab = trace_bath(rho, a, b, agg, FCProd, aggInds, vibindices)
        @test 1e-7 > abs(rho_traced_ref[a, b] - rho_traced_ab)

        rho_ab = take_el_part(rho.data, a, b, vibindices)
        rho_traced_ab = trace_bath_part(
            rho_ab,
            a,
            b,
            agg,
            FCProd,
            aggInds,
            vibindices
        )
        @test 1e-7 > abs(rho_traced_ref[a, b] - rho_traced_ab)
    end

    rho_bath = get_rho_bath(rho0, agg, FCProd, aggInds, vibindices)
    rho_traced = trace_bath(rho_bath, agg, FCProd, aggInds, vibindices)
    rho_traced_ref = [1.0 1.0 1.0; 1.0 1.0 1.0; 1.0 1.0 1.0]
    @test 1e-10 > D(rho_traced_ref, rho_traced.data)

    rho_traced = trace_bath(rho0, agg, FCProd, aggInds, vibindices)
    rho0_ad = ad(rho_traced, rho_bath, agg, FCProd, aggInds, vibindices)
    @test 1e-7 > D(rho0, rho0_ad)

    rho_bath = get_rho_bath(rho0, agg, FCProd, aggInds, vibindices)

    t = 0.0
    Ham_II_t = getInteractionHamIPicture(Ham_S, Ham_int, t)
    prod = Ham_II_t * Ham_int * rho_bath
    corr_ref = trace_bath(prod, agg, FCProd, aggInds, vibindices)
    corr = correlation_function(
        t,
        rho_bath,
        Ham_S,
        Ham_int,
        agg,
        FCProd,
        aggInds,
        vibindices
    )
    @test 1e-7 > D(corr, corr_ref)

    t = 1.0
    Ham_II_t = getInteractionHamIPicture(Ham_S, Ham_int, t)
    prod = Ham_II_t * Ham_int * rho_bath
    corr_ref = trace_bath(prod, agg, FCProd, aggInds, vibindices)
    corr = correlation_function(
        t,
        rho_bath,
        Ham_S,
        Ham_int,
        agg,
        FCProd,
        aggInds,
        vibindices
    )
    @test 1e-7 > D(corr, corr_ref)

end
