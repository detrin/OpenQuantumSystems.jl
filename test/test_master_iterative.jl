using Test
using OpenQuantumSystems
using Random, SparseArrays, LinearAlgebra, StableRNGs

@testset "rate_constant" begin

    Random.seed!(StableRNG(0), 1)

    D(op1::Array, op2::Array) = abs(norm(op1 - op2))
    D(x1::StateVector, x2::StateVector) = norm(x2 - x1)
    D(op1::AbstractOperator, op2::AbstractOperator) =
        abs(tracedistance_nh(dense(op1), dense(op2)))
    D(op1::AbstractSuperOperator, op2::AbstractSuperOperator) =
        abs(tracedistance_nh(dense(op1), dense(op2)))


    mode1 = Mode(0.2, 1.0)
    mode2 = Mode(0.3, 2.0)
    Energy = [0.0, 200.0]
    mol1 = Molecule([mode1], 3, [2.0, 200.0])
    mol2 = Molecule([mode2], 3, [3.0, 300.0])
    aggCore = AggregateCore([mol1, mol2])
    aggCore.coupling[2, 3] = 50
    aggCore.coupling[3, 2] = 50
    agg = setupAggregate(aggCore)
    aggTools = agg.tools
    aggOperators = agg.operators

    Ham_B = agg.operators.Ham_B
    Ham_I = agg.operators.Ham_I
    Ham_0 = agg.operators.Ham_0
    Ham = agg.operators.Ham

    Ham_0_lambda, Ham_0_S = eigen(Ham_0.data)
    Ham_0_Sinv = inv(Ham_0_S)
    Ham_0_lambda = diagm(Ham_0_lambda)

    basis = agg.tools.basis
    indicesLen = agg.tools.bSize
    indices = agg.tools.indices
    indicesMap = agg.tools.indicesMap
    FCFact = agg.tools.FCfactors
    FCProd = agg.tools.FCproduct

    tspan = get_tspan(0., 0.02, 100)
    W0, rho0, W0_bath = ultrafast_laser_excitation(10., [0.0, 0.3, 0.7], agg)

    tmp1 = copy(W0.data)
    tmp2 = copy(W0.data)
    p = (agg.core, agg.tools, agg.operators, W0, W0_bath, eltype(W0))

    t = 0.01
    ref = ComplexF64[0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im; 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523651409487161 - 3.0970772119919346e-23im 7.868386627845806e-13 - 1.651334282695512e-10im -8.51688399422316e-15 - 8.03912591526592e-17im -7.794078601707155e-14 + 1.9411391004017043e-11im -8.5174878766264725e-16 - 4.970566198855107e-18im -3.945860908146605e-22 + 3.741487795538906e-20im 6.060624348587404e-16 + 3.595438063407991e-18im -3.8629086801666255e-23 + 5.227928111876064e-21im 2.0040432384667535e-25 + 2.419494153928969e-27im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 7.868386627831208e-13 + 1.6513342826954993e-10im 0.1514218493110728 + 3.7488119843508325e-23im 1.1057389388287185e-12 - 2.3205597268729886e-10im 8.517564898276958e-16 - 3.4537062932733863e-18im -7.745825505517687e-14 + 1.9291215149943966e-11im -1.1969738060663324e-15 - 6.985311052157875e-18im -1.4465326929418526e-23 - 5.228053278090625e-21im 6.023103058074043e-16 + 3.573178729658463e-18im -5.428785526103988e-23 + 7.347045957673337e-21im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -8.516883994217536e-15 + 8.039125914830776e-17im 1.1057389388293856e-12 + 2.3205597268729987e-10im 0.15048439759177404 + 6.872087690757351e-23im 3.364270785296984e-22 + 3.7415460710389064e-20im 1.1969846303810673e-15 - 4.8535986615543285e-18im -7.697869189782694e-14 + 1.9171758209376703e-11im 2.0041278371084883e-25 - 1.5971218477789782e-27im -2.0328889775220158e-23 - 7.347221860096202e-21im 5.985812715088828e-16 + 3.551056920787875e-18im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -7.794078601751775e-14 - 1.9411391004016862e-11im 8.517564898309297e-16 + 3.4537062911602075e-18im 3.3642703432965394e-22 - 3.741546077432654e-20im 0.1517356291858619 + 9.227040007167671e-23im 7.835877604760286e-13 - 1.644511630626819e-10im -8.48169563951726e-15 - 8.005911464860115e-17im -1.0976520266533686e-13 + 2.7336191120034454e-11im -1.1995711362729981e-15 - 7.000356285444086e-18im -5.557206820638684e-22 + 5.269378202449286e-20im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -8.517487876637121e-16 + 4.9705661971955094e-18im -7.74582550548266e-14 - 1.9291215149943213e-11im 1.1969846303812972e-15 + 4.8535986675528176e-18im 7.8358776047723e-13 + 1.6445116306268162e-10im 0.15079623485161756 + 8.765196034132111e-23im 1.101170468275717e-12 - 2.3109721032242537e-10im 1.1995819836982124e-15 - 4.8640708061870334e-18im -1.0908564692134984e-13 + 2.716695285605063e-11im -1.6857731400605417e-15 - 9.83784628906201e-18im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -3.945861223704436e-22 - 3.741487791529768e-20im -1.196973806064086e-15 + 6.985311050712138e-18im -7.697869189758517e-14 - 1.917175820937662e-11im -8.481695639494184e-15 + 8.005911465401056e-17im 1.1011704682765135e-12 + 2.3109721032242845e-10im 0.14986265630751314 + 8.920686556805393e-23im 4.738117258823569e-22 + 5.26946027466291e-20im 1.6857883845996715e-15 - 6.835626886434508e-18im -1.0841027078409995e-13 + 2.6998727002963545e-11im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 6.060624348623924e-16 - 3.595438064401818e-18im -1.446533803942828e-23 + 5.228053284180766e-21im 2.0041267662681036e-25 + 1.5971706277591268e-27im -1.097652026646221e-13 - 2.7336191120033986e-11im 1.1995819837035583e-15 + 4.8640708043161396e-18im 4.738117093146213e-22 - 5.2694602709306936e-20im 0.1511087183129731 + 3.4158130313996964e-23im 7.803503166066082e-13 - 1.6377172202110822e-10im -8.44665287287058e-15 - 7.972834453871719e-17im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im -3.8629110070781484e-23 - 5.227928107109489e-21im 6.023103058091149e-16 - 3.573178725638523e-18im -2.0328903035387674e-23 + 7.347221844561371e-21im -1.1995711362638132e-15 + 7.000356275011023e-18im -1.0908564692151726e-13 - 2.7166952856050334e-11im 1.6857883845978383e-15 + 6.835626885889262e-18im 7.803503166067239e-13 + 1.6377172202110933e-10im 0.15017320518003416 + 1.4615118568475777e-22im 1.0966209107506535e-12 - 2.3014241665428528e-10im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 2.0040437102176764e-25 - 2.419594546828888e-27im -5.428785226270278e-23 - 7.347045945282214e-21im 5.985812715062555e-16 - 3.551056919454514e-18im -5.557208053445596e-22 - 5.269378203765235e-20im -1.6857731400593328e-15 + 9.837846289962847e-18im -1.0841027078332011e-13 - 2.699872700296472e-11im -8.446652872854445e-15 + 7.97283445341102e-17im 1.0966209107546345e-12 + 2.3014241665428572e-10im 0.14924348380871852 + 5.808493729515938e-23im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im; 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.2259791293296045 + 1.3998079244211608e-22im -9.894247233486348e-13 + 2.2827718886392578e-10im 1.5294374950298855e-14 + 1.2647865634191963e-16im 9.00657090258949e-14 - 2.8374516005118665e-11im -4.3267623959174466e-16 - 1.998040970894739e-18im -5.395319130558257e-23 + 7.900946891288038e-21im -4.862113704602657e-16 - 3.060395328677511e-18im -4.854891495372001e-23 + 6.330563269985544e-21im 1.0097445058563554e-25 + 9.837106194352182e-28im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -9.89424723349031e-13 - 2.2827718886392523e-10im 0.22458009394882553 + 1.0352937499629216e-22im -1.3904004223280756e-12 + 3.2076514419642387e-10im 4.326801143307617e-16 + 8.525841432195276e-19im 8.950811282014068e-14 - 2.8198849564642574e-11im -6.080947951564951e-16 - 2.8080933122410834e-18im 3.390183014901406e-23 - 6.330661113951573e-21im -4.832012390491498e-16 - 3.041448440390558e-18im -6.823217754711899e-23 + 8.897187733750686e-21im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 1.5294374950250104e-14 - 1.2647865634461416e-16im -1.3904004223282566e-12 - 3.207651441964242e-10im 0.22318971997718248 + 9.881987552316522e-23im 4.9413809581744855e-25 + 7.90113480700767e-21im 6.08100240781264e-16 + 1.1982474476571966e-18im 8.895398672784701e-14 - 2.8024276006840577e-11im 1.0097885532609652e-25 + 3.6525825909393427e-28im 4.764676471972741e-23 - 8.897325224205331e-21im -4.802098115226221e-16 - 3.0226193073222347e-18im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 9.006570902564375e-14 + 2.8374516005119066e-11im 4.3268011433365776e-16 - 8.525841429632858e-19im 4.9414577555379495e-25 - 7.901134820549737e-21im 0.22504547403820083 + 1.4605349606314894e-22im -9.853368164966367e-13 + 2.2733403890155937e-10im 1.523118471577701e-14 + 1.2595609708421325e-16im 1.2684213905075858e-13 - 3.996043837246469e-11im -6.093526202326088e-16 - 2.8139207487510964e-18im -7.598481060066737e-23 + 1.1127236324857589e-20im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -4.3267623959123954e-16 + 1.998040969754298e-18im 8.950811282091968e-14 + 2.81988495646428e-11im 6.081002407832418e-16 - 1.1982474466137476e-18im -9.853368164969538e-13 - 2.27334038901559e-10im 0.22365221891150996 + 7.724787518559499e-23im -1.3846558444222907e-12 + 3.194398710266658e-10im 6.093580772049141e-16 + 1.2007256739675788e-18im 1.2605686021166123e-13 - 3.971304356342191e-11im -8.564005202768123e-16 - 3.954749752042654e-18im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -5.395318961036712e-23 - 7.900946900902539e-21im -6.080947951561216e-16 + 2.808093314441404e-18im 8.895398672795816e-14 + 2.8024276006840787e-11im 1.5231184715674335e-14 - 1.2595609711074967e-16im -1.3846558444232062e-12 - 3.194398710266708e-10im 0.22226758940847996 + 7.239486963182734e-23im 6.959885273419531e-25 + 1.1127501007797408e-20im 8.564081895922974e-16 + 1.6875360432981845e-18im 1.2527646843463782e-13 - 3.946718788455866e-11im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -4.862113704603793e-16 + 3.060395328210789e-18im 3.390182540877749e-23 + 6.330661102291755e-21im 1.0097879984623855e-25 - 3.652315701267422e-28im 1.2684213905078986e-13 + 3.996043837246528e-11im 6.093580772079612e-16 - 1.2007256750705793e-18im 6.95990767652057e-25 - 1.1127500990163422e-20im 0.2241156762371643 + 6.6319413129869e-23im -9.812657918056523e-13 + 2.263947792322357e-10im 1.516825545545631e-14 + 1.2543569672458228e-16im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im -4.854891219482011e-23 - 6.330563271439681e-21im -4.832012390460441e-16 + 3.04144844163836e-18im 4.764675199388697e-23 + 8.897325226763904e-21im -6.09352620237817e-16 + 2.8139207502860572e-18im 1.2605686021122934e-13 + 3.971304356342308e-11im 8.564081895958691e-16 - 1.6875360455440724e-18im -9.812657918062444e-13 - 2.2639477923223437e-10im 0.22272817748286272 + 9.453367006774695e-23im -1.3789349903455121e-12 + 3.1812006432512253e-10im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 1.009745001079775e-25 - 9.837392605555673e-28im -6.823217788657324e-23 - 8.897187699824344e-21im -4.802098115232547e-16 + 3.0226193114556336e-18im -7.598481255242516e-23 - 1.1127236338185376e-20im -8.564005202806758e-16 + 3.954749751579639e-18im 1.2527646843426838e-13 + 3.9467187884557865e-11im 1.51682554554437e-14 - 1.254356967053798e-16im -1.3789349903464536e-12 - 3.181200643251274e-10im 0.22134926871459829 + 7.347542261554316e-23im]
    W_1_bath_ = W_1_bath(t, p, tmp1, tmp2)
    @test D(ref, W_1_bath_) < 1e-14

    W_1_bath_ = W_1_bath(t, W0, W0_bath, agg)
    @test D(ref, W_1_bath_) < 1e-14

    W_1_bath_normalized = normalize_bath(W_1_bath_, aggCore, aggTools)
    rho_ = trace_bath(W_1_bath_normalized, agg.core, agg.tools)
    ref = ComplexF64[1.0 + 0.0im 1.0 + 0.0im 1.0 + 0.0im;1.0 + 0.0im 1.0 + 0.0im 1.0 + 0.0im;1.0 + 0.0im 1.0 + 0.0im 1.0 + 0.0im]
    @test D(ref, rho_) < 1e-14

end