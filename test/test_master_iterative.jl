using Test
using OpenQuantumSystems
using Random, SparseArrays, LinearAlgebra, StableRNGs

@testset "rate_constant" begin

    Random.seed!(StableRNG(0), 1)

    D(op1::Array, op2::Array) = abs(norm(op1 - op2))
    D(x1::StateVector, x2::StateVector) = norm(x2 - x1)
    D(op1::AbstractOperator, op2::AbstractOperator) =
        abs(tracedistance_nh(dense(op1), dense(op2)))
    D(op1::AbstractSuperOperator, op2::AbstractSuperOperator) =
        abs(tracedistance_nh(dense(op1), dense(op2)))


    mode1 = Mode(0.2, 1.0)
    mode2 = Mode(0.3, 2.0)
    Energy = [0.0, 200.0]
    mol1 = Molecule([mode1], 3, [2.0, 200.0])
    mol2 = Molecule([mode2], 3, [3.0, 300.0])
    aggCore = AggregateCore([mol1, mol2])
    aggCore.coupling[2, 3] = 50
    aggCore.coupling[3, 2] = 50
    agg = setupAggregate(aggCore)
    aggTools = agg.tools
    aggOperators = agg.operators

    Ham_B = agg.operators.Ham_B
    Ham_I = agg.operators.Ham_I
    Ham_0 = agg.operators.Ham_0
    Ham = agg.operators.Ham

    Ham_0_lambda, Ham_0_S = eigen(Ham_0.data)
    Ham_0_Sinv = inv(Ham_0_S)
    Ham_0_lambda = diagm(Ham_0_lambda)

    basis = agg.tools.basis
    indicesLen = agg.tools.bSize
    indices = agg.tools.indices
    indicesMap = agg.tools.indicesMap
    FCFact = agg.tools.FCfactors
    FCProd = agg.tools.FCproduct

    tspan = get_tspan(0., 0.02, 100)
    W0, rho0, W0_bath = ultrafast_laser_excitation(10., [0.0, 0.3, 0.7], agg)

    tmp1 = copy(W0.data)
    tmp2 = copy(W0.data)
    p = (agg.core, agg.tools, agg.operators, W0, W0_bath, eltype(W0))

    t = 0.01
    ref = ComplexF64[0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im; 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.2219156179596201 - 4.511667697898788e-18im -1.239827810626761e-7 - 6.0890016847792985e-6im -2.3112023225071388e-7 + 2.391288715050148e-9im -2.908380278431557e-7 - 2.0302816366649943e-6im -9.310932900388009e-8 - 7.15902483586262e-6im -9.010941575975716e-8 - 8.072322414142208e-6im -2.3224702407293124e-7 + 6.265672159914433e-10im -1.991830997261859e-8 - 1.4143316670494513e-5im -2.6294071349606714e-9 + 4.08792545765501e-9im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -1.2398278106259497e-7 + 6.0890016847792706e-6im 0.22054151315601117 - 1.0778650686617599e-18im -1.881211363240463e-8 - 8.546748884340188e-6im -6.970801112929724e-8 + 1.4348761476593254e-6im -4.5823434132701117e-7 - 2.0176975028836885e-6im 1.03501465170448e-7 - 1.0049597564524228e-5im -2.038368939729585e-8 - 2.0151583567228727e-6im -2.2918346380601332e-7 + 4.855473675997688e-10im 9.942953721785836e-8 - 1.986539021060269e-5im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -2.311202322507151e-7 - 2.3912887150455517e-9im -1.881211363241699e-8 + 8.546748884340173e-6im 0.21917694814631156 - 3.2194156325627462e-18im -1.1311880214412919e-7 + 4.0380948506821005e-6im 5.126299430854833e-8 + 2.004654438240537e-6im 2.432434145911137e-7 - 2.0037628246732222e-6im 9.598124921694435e-11 - 4.932577080312497e-10im 3.5574501837460994e-8 - 2.844753821844849e-6im 4.609266624725976e-7 + 3.0700792085301164e-9im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -2.908380278431224e-7 + 2.030281636664981e-6im -6.97080111292631e-8 - 1.4348761476593408e-6im -1.1311880214410311e-7 - 4.038094850682106e-6im 0.22099892203489926 + 4.545584815160811e-19im 1.395332991693941e-8 - 6.0643547739656574e-6im -1.2556660093761656e-8 + 2.765792785060586e-9im -1.7121733080089532e-7 - 5.971348217806438e-10im 5.928211510697947e-8 - 1.0082423833374309e-5im 8.368353404298694e-8 + 2.2655852008880813e-9im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -9.3109329003859e-8 + 7.15902483586265e-6im -4.5823434132696077e-7 + 2.0176975028835894e-6im 5.1262994308485216e-8 - 2.004654438240406e-6im 1.3953329916916858e-8 + 6.064354773965624e-6im 0.21963069252197695 - 4.060671365816386e-19im 1.3535425254513195e-7 - 8.510420827571576e-6im 2.2436792763888158e-8 + 2.021128944821861e-6im -4.740460676122951e-8 - 9.558284056785396e-10im 1.2583518772753008e-7 - 1.4157158784409829e-5im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -9.010941575976158e-8 + 8.072322414142256e-6im 1.0350146517047663e-7 + 1.0049597564524111e-5im 2.432434145910896e-7 + 2.003762824673208e-6im -1.2556660093757318e-8 - 2.765792785055365e-9im 1.3535425254532965e-7 + 8.510420827571576e-6im 0.2182716808861649 - 2.1043613086202945e-18im 8.504443352702955e-8 - 2.326436005696748e-9im 1.3862193773944927e-7 + 2.827171497585557e-6im 5.810672710776283e-7 + 3.4394656369168295e-10im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -2.3224702407293365e-7 - 6.26567215991804e-10im -2.038368939722592e-8 + 2.015158356722825e-6im 9.598124921601885e-11 + 4.932577080315176e-10im -1.7121733080089368e-7 + 5.971348217809929e-10im 2.2436792763981986e-8 - 2.0211289448219074e-6im 8.504443352703278e-8 + 2.326436005699354e-9im 0.22008601339200734 + 8.06973140551637e-19im 9.082277867332832e-9 - 6.039286234446752e-6im 2.4028636263230557e-7 + 1.5288337749568937e-9im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im -1.991830997248838e-8 + 1.4143316670494518e-5im -2.2918346380600734e-7 - 4.855473675944588e-10im 3.557450183747688e-8 + 2.84475382184466e-6im 5.928211510694655e-8 + 1.008242383337422e-5im -4.7404606761236014e-8 + 9.558284056796797e-10im 1.3862193773943921e-7 - 2.827171497585437e-6im 9.082277867282807e-9 + 6.0392862344467774e-6im 0.21872380585532797 - 1.0950966456878909e-18im 1.2678763525848168e-8 - 8.473773666792686e-6im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im -2.6294071349640736e-9 - 4.087925457652339e-9im 9.942953721792354e-8 + 1.9865390210602454e-5im 4.609266624725993e-7 - 3.0700792085311074e-9im 8.368353404298449e-8 - 2.265585200893865e-9im 1.2583518772767172e-7 + 1.4157158784409798e-5im 5.810672710776287e-7 - 3.439465636882449e-10im 2.4028636263230816e-7 - 1.5288337749547891e-9im 1.26787635258814e-8 + 8.473773666792813e-6im 0.21737028151319188 - 9.620449731834836e-20im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im; 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.17782523984067516 - 1.1599987697196399e-18im 8.584198654368772e-8 + 4.215843492209186e-6im 1.6002076818069974e-7 - 1.6556571157754484e-9im 2.013675920034991e-7 + 1.4057065621580695e-6im 6.446612746499471e-8 + 4.956695666594912e-6im 6.238907684440777e-8 + 5.589035720214207e-6im 1.608009252929464e-7 - 4.3381648695964295e-10im 1.3790844841396852e-8 + 9.79241140507573e-6im 1.8205232207537192e-9 - 2.830357886151221e-9im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 8.584198654366529e-8 - 4.2158434922092495e-6im 0.17672448177812414 - 2.3549992623068695e-19im 1.3024947427650296e-8 + 5.917514484133004e-6im 4.8263751643965286e-8 - 9.934655272568334e-7im 3.172678159408534e-7 + 1.396993682567402e-6im -7.166133316470439e-8 + 6.958042169314318e-6im 1.4113059700188873e-8 + 1.3952356533581485e-6im 1.5867980736870527e-7 - 3.361785421932323e-10im -6.884205147480672e-8 + 1.375420477365198e-5im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 1.600207681806944e-7 + 1.6556571157758569e-9im 1.3024947427622445e-8 - 5.917514484133051e-6im 0.1756298234775435 - 8.20798588092471e-19im 7.832009096952546e-8 - 2.7958566573774023e-6im -3.549297112001231e-8 - 1.3879630529110349e-6im -1.6841449871665281e-7 + 1.387345726220733e-6im -6.645455953000497e-11 + 3.4151695237305657e-10im -2.4630725991682917e-8 + 1.969622855703983e-6im -3.1913189894958347e-7 - 2.1256314453275593e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 2.0136759200349937e-7 - 1.4057065621580612e-6im 4.826375164397404e-8 + 9.934655272568976e-7im 7.832009096953805e-8 + 2.79585665737743e-6im 0.17709041904837255 - 5.432973089303475e-19im -9.660870232911576e-9 + 4.198778704919669e-6im 8.69385762734804e-9 - 1.914952584568861e-9im 1.1854578257299178e-7 + 4.1343837342885983e-10im -4.104517162512971e-8 + 6.9807701006027695e-6im -5.793998764723814e-8 - 1.5686237448612545e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 6.44661274649952e-8 - 4.9566956665949e-6im 3.1726781594084925e-7 - 1.3969936825673855e-6im -3.549297112000808e-8 + 1.3879630529110656e-6im -9.660870232939215e-9 - 4.198778704919554e-6im 0.17599407176061066 + 6.7383567624114175e-19im -9.371525486059335e-8 + 5.892362019141318e-6im -1.553456734898905e-8 - 1.399369510808509e-6im 3.2821538449347054e-8 + 6.617871323350863e-10im -8.712453777101217e-8 + 9.8019952726602e-6im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 6.238907684441046e-8 - 5.5890357202142106e-6im -7.166133316470405e-8 - 6.9580421693142874e-6im -1.684144987166484e-7 - 1.387345726220709e-6im 8.693857627348491e-9 + 1.914952584569367e-9im -9.371525486058212e-8 - 5.892362019141197e-6im 0.17490399462915063 + 4.994829333143651e-19im -5.888223393496474e-8 + 1.6107550305243367e-9im -9.597770280761363e-8 - 1.957449377826403e-6im -4.0231367966802335e-7 - 2.3813836114300546e-10im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 1.6080092529294722e-7 + 4.338164869590708e-10im 1.4113059700158716e-8 - 1.3952356533581237e-6im -6.645455952773191e-11 - 3.4151695237294485e-10im 1.185457825729897e-7 - 4.134383734287982e-10im -1.5534567348967308e-8 + 1.399369510808517e-6im -5.888223393496541e-8 - 1.6107550305248214e-9im 0.17635863433745133 - 3.614453788193617e-20im -6.288298808836944e-9 + 4.181421994466642e-6im -1.6636712397408275e-7 - 1.058518991205277e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 1.3790844841422852e-8 - 9.79241140507578e-6im 1.5867980736870865e-7 + 3.3617854219775145e-10im -2.4630725991694037e-8 - 1.969622855704143e-6im -4.104517162509708e-8 - 6.9807701006027085e-6im 3.282153844934456e-8 - 6.617871323341877e-10im -9.597770280762529e-8 + 1.957449377826144e-6im -6.28829880889034e-9 - 4.181421994466659e-6im 0.17526656123337422 - 2.939884746999151e-19im -8.778398408590273e-9 + 5.866988616032207e-6im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 1.8205232207496408e-9 + 2.8303578861520133e-9im -6.88420514748143e-8 - 1.3754204773651912e-5im -3.191318989495811e-7 + 2.125631445328055e-9im -5.793998764724377e-8 + 1.5686237448616341e-9im -8.712453777102459e-8 - 9.801995272660153e-6im -4.023136796680241e-7 + 2.381383611430393e-10im -1.6636712397408272e-7 + 1.0585189912047135e-9im -8.778398408614438e-9 - 5.866988616032077e-6im 0.17418107620948678 - 3.286824939007623e-19im]
    W_1_bath_ = W_1_bath_1(t, p, tmp1, tmp2)
    @test D(ref, W_1_bath_) < 1e-11

    W_1_bath_ = W_1_bath_1(t, W0, W0_bath, agg)
    @test D(ref, W_1_bath_) < 1e-11

    W_1_bath_normalized = normalize_bath(W_1_bath_, aggCore, aggTools)
    rho_ = trace_bath(W_1_bath_normalized, agg.core, agg.tools)
    ref = ComplexF64[1.0 + 0.0im 1.0 + 0.0im 1.0 + 0.0im;1.0 + 0.0im 1.0 + 0.0im 1.0 + 0.0im;1.0 + 0.0im 1.0 + 0.0im 1.0 + 0.0im]
    @test D(ref, rho_) < 1e-14

    ref = ComplexF64[0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im; 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.22191561795645093 - 1.1664254061761059e-18im -1.088009079573863e-7 - 6.089327610830629e-6im -2.311269597743786e-7 + 1.0991095631107927e-9im -2.8746197906573446e-7 - 2.0308208996102714e-6im -6.334722097591026e-8 - 7.159390533186045e-6im -3.640808108837618e-8 - 8.07279586197251e-6im -2.3224724678916884e-7 - 2.3940098699434043e-10im 6.240389760637677e-8 - 1.4143182085189044e-5im -2.66139367738708e-9 + 4.066064527158185e-9im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -1.0880090795744109e-7 + 6.089327610830566e-6im 0.2205415131614804 - 1.4837959956157256e-18im 2.517301837171014e-9 - 8.546772224629706e-6im -6.85169483051703e-8 + 1.4349405783872912e-6im -4.5487121215370186e-7 - 2.018549276045369e-6im 1.4529148969394252e-7 - 1.0049019417574954e-5im -1.8704605634539576e-8 - 2.015176641611624e-6im -2.2917946825044543e-7 - 3.6979904745554246e-10im 2.1506357686040542e-7 - 1.9864369793945172e-5im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -2.3112695977438263e-7 - 1.0991095631095449e-9im 2.5173018372565243e-9 + 8.54677222462983e-6im 0.2191769481477438 - 1.7117362771842983e-18im -9.96855135743447e-8 + 4.038491771695938e-6im 5.293983634429354e-8 + 2.0046060173349197e-6im 2.4657510544489395e-7 - 2.0033064752515678e-6im 9.599740019474762e-11 - 4.934549376288999e-10im 3.7948306269314385e-8 - 2.844719567636348e-6im 4.609104358442567e-7 + 4.787940008606452e-9im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -2.8746197906572503e-7 + 2.0308208996102544e-6im -6.85169483052383e-8 - 1.4349405783872597e-6im -9.968551357433043e-8 - 4.038491771695878e-6im 0.2209989220362215 - 1.8739244490697626e-18im 2.908216015555766e-8 - 6.064294917188557e-6im -1.2567950702428195e-8 + 2.6960884130588722e-9im -1.7121490230715395e-7 - 9.163232946705295e-10im 1.0120283174670764e-7 - 1.0082051397013128e-5im 8.366617526497217e-8 + 2.8908483318564216e-9im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -6.33472209759378e-8 + 7.1593905331860515e-6im -4.548712121536941e-7 + 2.0185492760453805e-6im 5.2939836344301235e-8 - 2.004606017334969e-6im 2.9082160155557253e-8 + 6.064294917188498e-6im 0.21963069252873946 - 1.002797616177216e-18im 1.5659158803410048e-7 - 8.510013377534115e-6im 2.4122849042951203e-8 + 2.0211072006868115e-6im -4.740000081551655e-8 - 1.0447684604593231e-9im 1.8469909299149978e-7 - 1.4156437501682187e-5im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -3.640808108838426e-8 + 8.072795861972485e-6im 1.4529148969401544e-7 + 1.0049019417575134e-5im 2.4657510544490205e-7 + 2.0033064752516e-6im -1.25679507024319e-8 - 2.6960884130582138e-9im 1.5659158803394198e-7 + 8.51001337753432e-6im 0.21827168088224674 + 1.1315281539781073e-18im 8.503675548678541e-8 - 2.643599651618594e-9im 1.409771060944123e-7 + 2.827041395495669e-6im 5.810589671990258e-7 + 1.4265734456577115e-9im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -2.3224724678917297e-7 + 2.3940098699824814e-10im -1.8704605634517844e-8 + 2.0151766416115464e-6im 9.599740019398272e-11 + 4.934549376342607e-10im -1.712149023071517e-7 + 9.16323294671364e-10im 2.412284904287982e-8 - 2.021107200686933e-6im 8.503675548678087e-8 + 2.643599651620628e-9im 0.2200860133922582 - 2.3190294400698195e-18im 2.4153693784790644e-8 - 6.039240060934119e-6im 2.402736685519796e-7 + 2.8727986875488657e-9im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 6.240389760647078e-8 + 1.4143182085188966e-5im -2.29179468250453e-7 + 3.697990474583832e-10im 3.7948306269409e-8 + 2.8447195676363208e-6im 1.0120283174672106e-7 + 1.0082051397013059e-5im -4.7400000815514356e-8 + 1.044768460462609e-9im 1.4097710609442942e-7 - 2.827041395495533e-6im 2.415369378484156e-8 + 6.039240060934027e-6im 0.21872380585453027 + 3.1234908184786177e-18im 3.381614198124993e-8 - 8.473709224526545e-6im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im -2.661393677385388e-9 - 4.066064527156163e-9im 2.1506357686040442e-7 + 1.9864369793945128e-5im 4.609104358442628e-7 - 4.78794000860609e-9im 8.366617526496963e-8 - 2.8908483318571723e-9im 1.8469909299150386e-7 + 1.4156437501682317e-5im 5.810589671990175e-7 - 1.426573445655312e-9im 2.4027366855197636e-7 - 2.87279868754559e-9im 3.381614198109627e-8 + 8.473709224526367e-6im 0.2173702815058397 - 3.3023705803632243e-19im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im; 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1523639192898371 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.17782523984287163 - 1.7443823186992824e-19im 7.53358922302731e-8 + 4.216069072006165e-6im 1.6002542437793542e-7 - 7.613523336799225e-10im 1.9903131344618697e-7 + 1.406079782476017e-6im 4.3870273634888205e-8 + 4.956948792876288e-6im 2.522689225296383e-8 + 5.589363476483416e-6im 1.6080107992201464e-7 + 1.655120001159198e-10im -4.317744254627444e-8 + 9.79231837822214e-6im 1.8426601419861995e-9 - 2.815229928026233e-9im; 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15142063521546414 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 7.533589223025533e-8 - 4.2160690720062035e-6im 0.17672448177433728 - 7.394162930439628e-19im -1.7353545991174122e-9 + 5.917530650951151e-6im 4.743951834412073e-8 - 9.935101193938854e-7im 3.149404731012743e-7 + 1.3975831885355406e-6im -1.0058070288813753e-7 + 6.957642082267956e-6im 1.2951104836538356e-8 + 1.3952483085541507e-6im 1.5867704022660987e-7 + 2.5579921861120353e-10im -1.4886266083448094e-7 + 1.3753498719185585e-5im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 1.6002542437793346e-7 + 7.61352333681254e-10im -1.7353545991504988e-9 - 5.917530650951259e-6im 0.1756298234765512 + 2.8520670463032857e-19im 6.902403859241453e-8 - 2.796131373599333e-6im -3.665337907728458e-8 - 1.3879295417094667e-6im -1.707200820128025e-7 + 1.387029892551977e-6im -6.646624452937365e-11 + 3.416534750174172e-10im -2.627344296299554e-8 + 1.96959914913785e-6im -3.191206680014409e-7 - 3.314546381135169e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 1.9903131344620478e-7 - 1.4060797824760678e-6im 4.7439518344136826e-8 + 9.935101193937906e-7im 6.902403859241989e-8 + 2.796131373599295e-6im 0.17709041904745698 - 5.043206412258807e-19im -2.0130264743191747e-8 + 4.198737287891814e-6im 8.701670497941235e-9 - 1.8667112123347076e-9im 1.1854410132688627e-7 + 6.343457143279096e-10im -7.00549823370147e-8 + 6.9805123839609725e-6im -5.792797411211367e-8 - 2.001363319177652e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216675 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 4.38702736348759e-8 - 4.9569487928763054e-6im 3.1494047310125295e-7 - 1.3975831885355725e-6im -3.6653379077307886e-8 + 1.387929541709453e-6im -2.0130264743236094e-8 - 4.1987372878917745e-6im 0.17599407175592668 - 4.918094441854815e-19im -1.0841183561407665e-7 + 5.892080040093619e-6im -1.6701349466791424e-8 - 1.3993544621744726e-6im 3.2818348731386224e-8 + 7.23342073674561e-10im -1.2785930410208716e-7 + 9.801496140365785e-6im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 2.5226892252954194e-8 - 5.5893634764834045e-6im -1.0058070288813755e-7 - 6.957642082268012e-6im -1.707200820128146e-7 - 1.3870298925519868e-6im 8.70167049794374e-9 + 1.8667112123339847e-9im -1.0841183561405491e-7 - 5.892080040093591e-6im 0.17490399463186407 - 2.194484193702025e-21im -5.887692050572484e-8 + 1.8302610796998812e-9im -9.760752006792283e-8 - 1.957359336030089e-6im -4.023079296037393e-7 - 9.874138846773289e-10im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1511075067286658 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 1.6080107992201252e-7 - 1.6551200011427942e-10im 1.2951104836537923e-8 - 1.3952483085542851e-6im -6.646624452833094e-11 - 3.4165347501855694e-10im 1.1854410132688356e-7 - 6.343457143272452e-10im -1.670134946680794e-8 + 1.3993544621744152e-6im -5.8876920505729186e-8 - 1.8302610796973835e-9im 0.1763586343372776 - 8.746478672510602e-19im -1.6717965189315814e-8 + 4.181390047454424e-6im -1.6635833854486379e-7 - 1.9886646090901593e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662565 + 0.0im 0.0 + 0.0im -4.3177442546264596e-8 - 9.792318378222163e-6im 1.5867704022660715e-7 - 2.557992186094542e-10im -2.627344296303473e-8 - 1.9695991491380117e-6im -7.005498233700719e-8 - 6.980512383961056e-6im 3.28183487313811e-8 - 7.233420736812007e-10im -9.760752006791001e-8 + 1.957359336029899e-6im -1.6717965189286353e-8 - 4.181390047454547e-6im 0.17526656123392587 - 8.361806653466038e-19im -2.340580043961928e-8 + 5.866944029323837e-6im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412077 + 0.0im 1.8426601419812735e-9 + 2.815229928025879e-9im -1.4886266083449274e-7 - 1.3753498719185693e-5im -3.19120668001441e-7 + 3.3145463811342957e-9im -5.792797411211027e-8 + 2.001363319177118e-9im -1.2785930410207843e-7 - 9.801496140365809e-6im -4.0230792960374344e-7 + 9.874138846785399e-10im -1.6635833854485852e-7 + 1.988664609090374e-9im -2.3405800439644782e-8 - 5.866944029323892e-6im 0.1741810762145776 - 5.478208722556527e-19im]
    W_1_bath_ = W_1_bath_2(t, p, tmp1, tmp2)
    @test D(ref, W_1_bath_) < 1e-11

    W_1_bath_ = W_1_bath_2(t, W0, W0_bath, agg)
    @test D(ref, W_1_bath_) < 1e-11

    ref = ComplexF64[0.1523639192898371 + 1.734723475976807e-18im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.09086999406699503 - 0.07041991681154827im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17683797078600402 + 0.04406290259988863im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.15142063521546423 - 1.734723475976807e-18im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.09030741850027767 - 0.06998394754561835im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17574316801140785 + 0.04379010944461383im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.1504831910069145 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08974832583538628 - 0.0695506773626956im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17465514315396338 + 0.04351900515006241im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15173441257438916 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.09049455563140929 - 0.07012896990797178im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17610734708798662 + 0.043880852326975965im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15079502577216672 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08993430440170586 - 0.06969480189250792im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17501706760014954 + 0.043609186243805644im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14986145470778003 + 1.734723475976807e-18im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08937752168387252 - 0.0692633218085208im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.1739335380258241 + 0.043339202043662525im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15110750672866582 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.09012066835713227 - 0.06983922508051996im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17537974203458337 + 0.04369955421290698im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.15017200109662568 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08956273186121272 - 0.06940685087347638im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17429396714509554 + 0.04342901054523053im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.14924228717412083 + 1.734723475976807e-18im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08900824954666091 - 0.06897715349245276im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17321491428117894 + 0.043160141811713904im; -0.09086999406699504 + 0.07041991681154827im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.17175997735340062 + 5.772468497731123e-18im -1.088009079573863e-7 - 6.089327610830629e-6im -2.311269597743786e-7 + 1.0991095631107927e-9im -2.8746197906573446e-7 - 2.0308208996102714e-6im -6.334722097591026e-8 - 7.159390533186045e-6im -3.640808108837618e-8 - 8.07279586197251e-6im -2.3224724678916884e-7 - 2.3940098699434043e-10im 6.240389760637677e-8 - 1.4143182085189044e-5im -2.66139367738708e-9 + 4.066064527158185e-9im 0.1009543876717105 - 0.08255354112025307im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im -0.09030741850027767 + 0.06998394754561833im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -1.0880090795744109e-7 + 6.089327610830566e-6im 0.17069638581669588 - 8.422689899522954e-18im 2.517301837171014e-9 - 8.546772224629706e-6im -6.85169483051703e-8 + 1.4349405783872912e-6im -4.5487121215370186e-7 - 2.018549276045369e-6im 1.4529148969394252e-7 - 1.0049019417574954e-5im -1.8704605634539576e-8 - 2.015176641611624e-6im -2.2917946825044543e-7 - 3.6979904745554246e-10im 2.1506357686040542e-7 - 1.9864369793945172e-5im 0.0 + 0.0im 0.10032937968705993 - 0.08204245266187801im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im -0.08974832583538626 + 0.0695506773626956im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -2.3112695977438263e-7 - 1.0991095631095449e-9im 2.5173018372565243e-9 + 8.54677222462983e-6im 0.16964041167557903 - 1.5589524084998754e-17im -9.96855135743447e-8 + 4.038491771695938e-6im 5.293983634429354e-8 + 2.0046060173349197e-6im 2.4657510544489395e-7 - 2.0033064752515678e-6im 9.599740019474762e-11 - 4.934549376288999e-10im 3.7948306269314385e-8 - 2.844719567636348e-6im 4.609104358442567e-7 + 4.787940008606452e-9im 0.0 + 0.0im 0.0 + 0.0im 0.09970824112294566 - 0.08153452834896223im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.09049455563140928 + 0.07012896990797178im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -2.8746197906572503e-7 + 2.0308208996102544e-6im -6.85169483052383e-8 - 1.4349405783872597e-6im -9.968551357433043e-8 - 4.038491771695878e-6im 0.17105050446027875 - 8.812818352976991e-18im 2.908216015555766e-8 - 6.064294917188557e-6im -1.2567950702428195e-8 + 2.6960884130588722e-9im -1.7121490230715395e-7 - 9.163232946705295e-10im 1.0120283174670764e-7 - 1.0082051397013128e-5im 8.366617526497217e-8 + 2.8908483318564216e-9im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.10053728455904787 - 0.08221246293874243im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08993430440170586 + 0.0696948018925079im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -6.33472209759378e-8 + 7.1593905331860515e-6im -4.548712121536941e-7 + 2.0185492760453805e-6im 5.2939836344301235e-8 - 2.004606017334969e-6im 2.9082160155557253e-8 + 6.064294917188498e-6im 0.16999150529459367 + 5.9360962877300125e-18im 1.5659158803410048e-7 - 8.510013377534115e-6im 2.4122849042951203e-8 + 2.0211072006868115e-6im -4.740000081551655e-8 - 1.0447684604593231e-9im 1.8469909299149978e-7 - 1.4156437501682187e-5im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.09991485885716728 - 0.08170348609326256im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08937752168387253 + 0.06926332180852078im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -3.640808108838426e-8 + 8.072795861972485e-6im 1.4529148969401544e-7 + 1.0049019417575134e-5im 2.4657510544490205e-7 + 2.0033064752516e-6im -1.25679507024319e-8 - 2.6960884130582138e-9im 1.5659158803394198e-7 + 8.51001337753432e-6im 0.16893980954677976 + 1.5009315961792564e-17im 8.503675548678541e-8 - 2.643599651618594e-9im 1.409771060944123e-7 + 2.827041395495669e-6im 5.810589671990258e-7 + 1.4265734456577115e-9im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0992962865889264 - 0.08119766032025971im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.09012066835713227 + 0.06983922508051994im 0.0 + 0.0im 0.0 + 0.0im -2.3224724678917297e-7 + 2.3940098699824814e-10im -1.8704605634517844e-8 + 2.0151766416115464e-6im 9.599740019398272e-11 + 4.934549376342607e-10im -1.712149023071517e-7 + 9.16323294671364e-10im 2.412284904287982e-8 - 2.021107200686933e-6im 8.503675548678087e-8 + 2.643599651620628e-9im 0.17034396268083696 + 4.619864463837409e-18im 2.4153693784790644e-8 - 6.039240060934119e-6im 2.402736685519796e-7 + 2.8727986875488657e-9im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.10012190474945905 - 0.08187279395572677im 0.0 + 0.0im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08956273186121273 + 0.06940685087347637im 0.0 + 0.0im 6.240389760647078e-8 + 1.4143182085188966e-5im -2.29179468250453e-7 + 3.697990474583832e-10im 3.7948306269409e-8 + 2.8447195676363208e-6im 1.0120283174672106e-7 + 1.0082051397013059e-5im -4.7400000815514356e-8 + 1.044768460462609e-9im 1.4097710609442942e-7 - 2.827041395495533e-6im 2.415369378484156e-8 + 6.039240060934027e-6im 0.16928970786893432 + 1.0062384722385846e-17im 3.381614198124993e-8 - 8.473709224526545e-6im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.09950205066138978 - 0.08136591999880305im 0.0 + 0.0im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.08900824954666091 + 0.06897715349245279im -2.661393677385388e-9 - 4.066064527156163e-9im 2.1506357686040442e-7 + 1.9864369793945128e-5im 4.609104358442628e-7 - 4.78794000860609e-9im 8.366617526496963e-8 - 2.8908483318571723e-9im 1.8469909299150386e-7 + 1.4156437501682317e-5im 5.810589671990175e-7 - 1.426573445655312e-9im 2.4027366855197636e-7 - 2.87279868754559e-9im 3.381614198109627e-8 + 8.473709224526367e-6im 0.1682422297126635 - 7.269130961943551e-18im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.09888603408611518 - 0.08086218409538634im; -0.17683797078600405 - 0.04406290259988863im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.1009543876717105 + 0.08255354112025307im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.2279808804459218 - 1.7443823186992824e-19im 7.53358922302731e-8 + 4.216069072006165e-6im 1.6002542437793542e-7 - 7.613523336799225e-10im 1.9903131344618697e-7 + 1.406079782476017e-6im 4.3870273634888205e-8 + 4.956948792876288e-6im 2.522689225296383e-8 + 5.589363476483416e-6im 1.6080107992201464e-7 + 1.655120001159198e-10im -4.317744254627444e-8 + 9.79231837822214e-6im 1.8426601419861995e-9 - 2.815229928026233e-9im; 0.0 + 0.0im -0.17574316801140788 - 0.043790109444613826im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.10032937968705995 + 0.08204245266187803im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 7.533589223025533e-8 - 4.2160690720062035e-6im 0.2265696091191218 - 1.461720410085842e-17im -1.7353545991174122e-9 + 5.917530650951151e-6im 4.743951834412073e-8 - 9.935101193938854e-7im 3.149404731012743e-7 + 1.3975831885355406e-6im -1.0058070288813753e-7 + 6.957642082267956e-6im 1.2951104836538356e-8 + 1.3952483085541507e-6im 1.5867704022660987e-7 + 2.5579921861120353e-10im -1.4886266083448094e-7 + 1.3753498719185585e-5im; 0.0 + 0.0im 0.0 + 0.0im -0.1746551431539634 - 0.04351900515006241im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.09970824112294566 + 0.08153452834896226im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 1.6002542437793346e-7 + 7.61352333681254e-10im -1.7353545991504988e-9 - 5.917530650951259e-6im 0.225166359948716 + 7.224100608537557e-18im 6.902403859241453e-8 - 2.796131373599333e-6im -3.665337907728458e-8 - 1.3879295417094667e-6im -1.707200820128025e-7 + 1.387029892551977e-6im -6.646624452937365e-11 + 3.416534750174172e-10im -2.627344296299554e-8 + 1.96959914913785e-6im -3.191206680014409e-7 - 3.314546381135169e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17610734708798662 - 0.043880852326975965im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.10053728455904788 + 0.08221246293874246im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 1.9903131344620478e-7 - 1.4060797824760678e-6im 4.7439518344136826e-8 + 9.935101193937906e-7im 6.902403859241989e-8 + 2.796131373599295e-6im 0.2270388366233998 - 7.443214545133109e-18im -2.0130264743191747e-8 + 4.198737287891814e-6im 8.701670497941235e-9 - 1.8667112123347076e-9im 1.1854410132688627e-7 + 6.343457143279096e-10im -7.00549823370147e-8 + 6.9805123839609725e-6im -5.792797411211367e-8 - 2.001363319177652e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17501706760014954 - 0.04360918624380564im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.09991485885716728 + 0.08170348609326256im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 4.38702736348759e-8 - 4.9569487928763054e-6im 3.1494047310125295e-7 - 1.3975831885355725e-6im -3.6653379077307886e-8 + 1.387929541709453e-6im -2.0130264743236094e-8 - 4.1987372878917745e-6im 0.22563325899007244 - 7.43070334809271e-18im -1.0841183561407665e-7 + 5.892080040093619e-6im -1.6701349466791424e-8 - 1.3993544621744726e-6im 3.2818348731386224e-8 + 7.23342073674561e-10im -1.2785930410208716e-7 + 9.801496140365785e-6im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.1739335380258241 - 0.043339202043662525im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.09929628658892639 + 0.08119766032025971im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 2.5226892252954194e-8 - 5.5893634764834045e-6im -1.0058070288813755e-7 - 6.957642082268012e-6im -1.707200820128146e-7 - 1.3870298925519868e-6im 8.70167049794374e-9 + 1.8667112123339847e-9im -1.0841183561405491e-7 - 5.892080040093591e-6im 0.22423586596733106 - 2.194484193702025e-21im -5.887692050572484e-8 + 1.8302610796998812e-9im -9.760752006792283e-8 - 1.957359336030089e-6im -4.023079296037393e-7 - 9.874138846773289e-10im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17537974203458334 - 0.04369955421290698im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.10012190474945902 + 0.08187279395572677im 0.0 + 0.0im 0.0 + 0.0im 1.6080107992201252e-7 - 1.6551200011427942e-10im 1.2951104836537923e-8 - 1.3952483085542851e-6im -6.646624452833094e-11 - 3.4165347501855694e-10im 1.1854410132688356e-7 - 6.343457143272452e-10im -1.670134946680794e-8 + 1.3993544621744152e-6im -5.8876920505729186e-8 - 1.8302610796973835e-9im 0.22610068504869874 + 1.3003139940563397e-17im -1.6717965189315814e-8 + 4.181390047454424e-6im -1.6635833854486379e-7 - 1.9886646090901593e-9im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17429396714509554 - 0.04342901054523054im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.09950205066138978 + 0.08136591999880305im 0.0 + 0.0im -4.3177442546264596e-8 - 9.792318378222163e-6im 1.5867704022660715e-7 - 2.557992186094542e-10im -2.627344296303473e-8 - 1.9695991491380117e-6im -7.005498233700719e-8 - 6.980512383961056e-6im 3.28183487313811e-8 - 7.233420736812007e-10im -9.760752006791001e-8 + 1.957359336029899e-6im -1.6717965189286353e-8 - 4.181390047454547e-6im 0.22470065921952176 + 6.102713238560625e-18im -2.340580043961928e-8 + 5.866944029323837e-6im; 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im -0.17321491428117897 - 0.04316014181171392im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0 + 0.0im 0.0988860340861152 + 0.08086218409538636im 1.8426601419812735e-9 + 2.815229928025879e-9im -1.4886266083449274e-7 - 1.3753498719185693e-5im -3.19120668001441e-7 + 3.3145463811342957e-9im -5.792797411211027e-8 + 2.001363319177118e-9im -1.2785930410207843e-7 - 9.801496140365809e-6im -4.0230792960374344e-7 + 9.874138846785399e-10im -1.6635833854485852e-7 + 1.988664609090374e-9im -2.3405800439644782e-8 - 5.866944029323892e-6im 0.22330912800775377 - 1.442560868007011e-17im]
    W_1_bath_ = W_1_bath_3(t, p, tmp1, tmp2)
    @test D(ref, W_1_bath_) < 1e-11

    W_1_bath_ = W_1_bath_3(t, W0, W0_bath, agg)
    @test D(ref, W_1_bath_) < 1e-11

end